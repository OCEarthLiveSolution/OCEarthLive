'''
Created on Apr 21, 2016

@author: neil
'''
from twitter_search import search_tweets
from EONet_json import EONet
from twitter_streaming import TweetMonitor
from rest import TweetRestAPI


# Main entry point of the system.
def main():
    '''
    Does a search through past tweets on the titles in the EONet JSON, and then
    filtering by tweets with geodata and the geolocation within the polygon
    given in the EONet JSON.  These are persisted to a SQLite database.
    '''
    # Retrieve the data from EONet (Earth Observatory Natural Event Tracket).
    eonet = EONet()
    
    # Search for recent tweets relating to the events provided by EONet.
    # This is done before monitoring the Twitter stream or listening for REST
    # requests.
#    search_tweets(eonet)
    
    # A semiphore for policing read/writes to the same store.  Serialize the
    # the connections to the store just to be extra safe.
#    maxconnections = 1
#    pool_sema = BoundedSemephone(value=maxconnections)
 
    # This thread monitors the Twitter stream.
    monitor_thread = TweetMonitor(eonet)
    monitor_thread.setName('monitor tweets')
    monitor_thread.start()
#    monitor_tweets(eonet)

    # This thread responds to REST calls.
    rest_thread = TweetRestAPI()
    rest_thread.setName('tweet REST API')
    rest_thread.start()

    
if __name__ == '__main__':
    '''
    Run the main program.  Catch a Ctrl-C and shutdown if entered at the
    keyboard.
    '''
    try:
        main()
    except KeyboardInterrupt:
        print('Ctrl-C from keyboard.  Shutting down.')
    except Exception as err:
        print('Exception: %s' % (err))
        raise