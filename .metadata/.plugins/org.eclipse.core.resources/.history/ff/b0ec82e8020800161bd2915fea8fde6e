'''
Created on Apr 21, 2016

@author: neil
'''
import tweepy
from osgeo import ogr
#from config import (ACCESS_TOKEN, ACCESS_TOKEN_SECRET,
#                    CONSUMER_KEY, CONSUMER_SECRET)
#from config import MAX_SEARCH_TWEETS


class TweetConsumer(object):
    '''
    Consumes the results of a Twitter search.  To use this class, create a
    subclass and implement the _save() method.
    '''
    __polygon = None
    title_matches = 0
    geo_enabled_matches = 0
    geo_matches = 0
    
    def __filter(self, tweet):
        '''
        Checks for the presence of geodata and if the coordinates are near
        the EONet event.  If yes to both, then ...
        '''
        self.title_matches += 1
        retval = False
        if tweet.coordinates is not None:
            self.geo_enabled_matches += 1
            geojson_point = json.dumps(tweet.coordinates)
            point = ogr.CreateGeometryFromJson(geojson_point)
            retval = point.Within(self.__polygon)
            
        if retval:
            self.geo_matches += 1

#        return retval
        return True
    
    # The polygon needs to be of type POLYGON.  It's a property of the search
    # that's calculated once, before the search, to avoid making this
    # calculation with every tweet.
    def set_polygon(self, poly):
        '''Sets the polygon to use in the search filter.'''
        self.__polygon = ogr.CreateGeometryFromJson(poly)
        
    def reset_counters(self):
        '''Sets the number of title and geo matches to zero.'''
        self.title_matches = 0
        self.geo_matches = 0
    
    def process(self, tweets):
        '''
        Iterate through the tweets, filtering out the relevant ones and then
        send them to a save method.'''
        for tweet in tweets:
            if self.__filter(tweet):
                self._save(tweet)
        
        
# This class is useful for initial development and detailed debugging.
class RawDump(TweetConsumer):
    '''Dumps the tweet, in raw json, to standard out.'''
    def _save(self, tweets):
        for tweet in tweets:
            print tweet


# This class presents refined output to standard out.  It's useful for
# high-level troubleshooting. 
class PrettyDump(TweetConsumer):
        '''
        Presents the most interesting parts of a tweet in formatted text to
        standard out.
        '''
        def _save(self, tweet):
            msg = tweet.text.encode('utf8', 'replace')
            name = tweet.user.name.encode('utf8', 'replace')
            msg_date = tweet.created_at
            place = tweet.place.name.encode('utf8', 'replace')
            print('[Name: %s][Place: %s][At: %s] %s' %
                  (name, place, msg_date, msg))
            