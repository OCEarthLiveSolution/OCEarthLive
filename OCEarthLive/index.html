<!DOCTYPE html>
<html>
<head>
    <title>OC Earth Live</title>

    <meta name="viewport" content="initial-scale=1.0">
    <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>

    <!-- OpenLayers -->
    <script src="http://openlayers.org/en/v3.8.2/build/ol.js" type="text/javascript"></script>
    <link rel="stylesheet" href="http://openlayers.org/en/v3.8.2/css/ol.css" type="text/css">

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">

    <script>window.twttr = (function (d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0],
                t = window.twttr || {};
        if (d.getElementById(id)) return t;
        js = d.createElement(s);
        js.id = id;
        js.src = "https://platform.twitter.com/widgets.js";
        fjs.parentNode.insertBefore(js, fjs);

        t._e = [];
        t.ready = function (f) {
            t._e.push(f);
        };

        return t;
    }(document, "script", "twitter-wjs"));</script>

    <meta charset="utf-8">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #map {
            height: 100%;
        }

        .selections {
            width: 600px;
            float: left;
        }

        .map {
            height: 400px;
            width: 400px;
            float: left;
        }

    </style>
</head>
<body>
<div id="map"></div>
<script>
    var map;

    var server = "http://eonet.sci.gsfc.nasa.gov/api/v2.1";

    var tweetServer = "http://tweet.beawork.com:5000/tweets";

    function initMap() {

        var myLatLng = {lat: 33.697998, lng: -117.846868};

        var map = new google.maps.Map(document.getElementById('map'), {
            zoom: 3,
            center: myLatLng
        });

        function getPinImage(pinColor) {
            var pinImage = new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|" + pinColor,
                    new google.maps.Size(21, 34),
                    new google.maps.Point(0, 0),
                    new google.maps.Point(10, 34));

            return pinImage;
        }

        function addInfoBox(id, title, category, tweet, image, event) {

            var contentString = "";

            var infowindow = new google.maps.InfoWindow({
                size: new google.maps.Size(150, 50)
            });

            google.maps.event.addListener(infowindow, 'domready', function () {
                twttr.widgets.load();
            });

            if (tweet != undefined) {

                contentString += "<br/><div class=\"infowindow-content\"><blockquote class=\"twitter-tweet\"><a href=\"" + tweet + "\">" + tweet + "</a></blockquote></div><script src=\"http://platform.twitter.com/widgets.js\"><\/script>";

            }

            if (id != undefined) {
                //contentString += "<br/>#" + id;
            }

            if (title != undefined) {
                contentString += "<br/>Event: " + title;
            }
            if (category != undefined) {
                contentString += "<br/>Category: " + category;
                //This is the NASA EONET Data so, we can tweet about it
                contentString += "<br/><a href=\"https://twitter.com/intent/tweet?button_hashtag=" + id + "&text=" + title + " #" + category + "\" class=\"twitter-hashtag-button\"></a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');<\/script>";

            }
            if (image != undefined || image != null) {
                contentString += "<br/><img src=" + image + "/>";
            }
            if (event != undefined) {
                contentString += "<br/>Location: " + event.latLng.toUrlValue(6);
            }

            infowindow.setContent(contentString);
            infowindow.setPosition(event.latLng);
            infowindow.open(map);

        }


        //Get the Tweets from our server
        $.getJSON(tweetServer, {
                    status: "open",
                    limit: 200
                })
                .done(function (data) {
                    $.each(data._items, function (key, event) {

                        var myId = event.eonet_id;
                        var tweetUser = event.screen_name;
                        var tweetId = event.tweet_id;
                        var tweet = "https://twitter.com/" + tweetUser + "/status/" + tweetId;
                        var image = event.media_url;

                        var myPoint = {};
                        myPoint.lat = parseFloat(JSON.parse(event.json_coordinates).coordinates[1]);
                        myPoint.lng = parseFloat(JSON.parse(event.json_coordinates).coordinates[0]);

                        var marker = new google.maps.Marker({
                            position: myPoint,
                            map: map,
                            title: name,
                            icon: getPinImage("00FFFF")
                        });

                        google.maps.event.addListener(marker, 'click', function (event) {
                            addInfoBox(myId, undefined, undefined, tweet, image, event);
                        });


                        marker.setMap(map);
                    });
                });

        //Get the events from the EONET Server
        $.getJSON(server + "/events", {
                    status: "open",
                    limit: 200
                })
                .done(function (data) {
                    $.each(data.events, function (key, event) {

                        var myId = event.id;
                        var myTitle = event.title;
                        var myCategory = event.categories[0].title;

                        if (event.geometries[0].type == 'Point') {

                            var myPoint = {};
                            myPoint.lat = parseFloat(event.geometries[0].coordinates[1]);
                            myPoint.lng = parseFloat(event.geometries[0].coordinates[0]);

                            //console.log(JSON.stringify(event.categories[0].title));

                            var marker = new google.maps.Marker({
                                position: myPoint,
                                map: map,
                                title: myTitle,
                                icon: getPinImage("FF0000")
                            });

                            google.maps.event.addListener(marker, 'click', function (event) {
                                addInfoBox(myId, myTitle, myCategory, undefined, undefined, event);
                            });

                            marker.setMap(map);
                        }

                        else if (event.geometries[0].type == 'Polygon') {

                            var allPolygons = event.geometries[0].coordinates[0];

                            var triangleCoords = [];

                            $.each(allPolygons, function (index, value) {
                                var coord = {lat: value[1], lng: value[0]};
                                triangleCoords.push(coord);

                            });

                            // console.log(JSON.stringify(event.categories[0].title));

                            // Construct the polygon.
                            var bermudaTriangle = new google.maps.Polygon({
                                paths: triangleCoords,
                                strokeColor: '#FF0000',
                                strokeOpacity: 0.8,
                                strokeWeight: 2,
                                fillColor: '#FF0000',
                                fillOpacity: 0.35,
                                title: myTitle
                            });

                            google.maps.event.addListener(bermudaTriangle, 'click', function (event) {
                                addInfoBox(myId, myTitle, myCategory, undefined, undefined, event);
                            });


                            bermudaTriangle.setMap(map);

                        }
                    });
                });
    }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCmYvnjnsFJEJ2ZnL8adoadKRWOD_euQXc&callback=initMap"
        async defer></script>
</body>
</html>