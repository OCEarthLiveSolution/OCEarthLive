<!DOCTYPE html>
<html>
  <head>
    <title>OC Earth Live</title>

    <meta name="viewport" content="initial-scale=1.0">
    <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>

    <meta charset="utf-8">
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      var map;

      var server = "http://eonet.sci.gsfc.nasa.gov/api/v2.1";

      
      function initMap() {

      var myLatLng = {lat: 33.629, lng: -117.949};
        
        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 4,
          center: myLatLng
        });

        var infowindow = new google.maps.InfoWindow({
                size: new google.maps.Size(150, 50)
              });

        function addInfoBox(myId, myTitle, myCategory, event){
            var contentString = "Id: " + myId + "<br/>Event: " + myTitle + "<br/>Category: " + myCategory + "<br/>Location: " + event.latLng.toUrlValue(6);
            infowindow.setContent(contentString);
            infowindow.setPosition(event.latLng);
            infowindow.open(map);
        }

       $.getJSON( server + "/events", {
            status: "open",
            limit: 20
        })
            .done(function( data ) {
                $.each( data.events, function( key, event ) {

                    var myId = JSON.stringify(event.id);
                    var myTitle = JSON.stringify(event.title);
                    var myCategory = JSON.stringify(event.categories[0].title);
                    
                    if (event.geometries[0].type == 'Point'){

                      var myPoint = {};
                      myPoint.lat = parseFloat(event.geometries[0].coordinates[1]);
                      myPoint.lng = parseFloat(event.geometries[0].coordinates[0]);
                      
                      //console.log(JSON.stringify(event.categories[0].title));

                      var marker = new google.maps.Marker({
                          position: myPoint,
                          map: map,
                          title: myTitle
                        });

                      google.maps.event.addListener(marker, 'click', function(event) {
                        addInfoBox(myId, myTitle, myCategory, event);
                      });

                      marker.setMap(map);
                    }

                    else if (event.geometries[0].type == 'Polygon'){

                      var allPolygons = event.geometries[0].coordinates[0];

                      var triangleCoords = [];  
  
                      $.each( allPolygons, function( index, value ){
                          var coord = {lat: value[1], lng: value[0]};
                          triangleCoords.push(coord);
                          
                      });
                       
                      // console.log(JSON.stringify(event.categories[0].title));

                      // Construct the polygon.
                      var bermudaTriangle = new google.maps.Polygon({
                        paths: triangleCoords,
                        strokeColor: '#FF0000',
                        strokeOpacity: 0.8,
                        strokeWeight: 2,
                        fillColor: '#FF0000',
                        fillOpacity: 0.35,
                        title: myTitle
                      });

                      google.maps.event.addListener(bermudaTriangle, 'click', function(event) {
                        addInfoBox(myId, myTitle, myCategory, event);
                      });

                    
                    bermudaTriangle.setMap(map);

                    }
                });
            });
      }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCmYvnjnsFJEJ2ZnL8adoadKRWOD_euQXc&callback=initMap"
    async defer></script>
  </body>
</html>