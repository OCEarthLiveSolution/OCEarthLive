<!DOCTYPE html>
<html>
  <head>
    <title>OC Earth Live</title>

    <meta name="viewport" content="initial-scale=1.0">
    <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>

    <meta charset="utf-8">
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      var map;

      var server = "http://eonet.sci.gsfc.nasa.gov/api/v2.1";

      function attachPolygonInfoWindow(polygon, html){
        polygon.infoWindow = new google.maps.InfoWindow({
          content: html,
        });
        google.maps.event.addListener(polygon, 'click', function(e) {
          var latLng = e.latLng;
          this.setOptions({fillOpacity:0.1});
          polygon.infoWindow.setPosition(latLng);
          polygon.infoWindow.open(map);
          console.log(html);
        });
        google.maps.event.addListener(polygon, 'mouseout', function() {
          this.setOptions({fillOpacity:0.35});
          polygon.infoWindow.close();
        });
      }


      function initMap() {

      var myLatLng = {lat: 33.629, lng: -117.949};
        
        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 2,
          center: myLatLng
        });


       $.getJSON( server + "/events", {
            status: "open",
            limit: 20
        })
            .done(function( data ) {
                $.each( data.events, function( key, event ) {

                    var myTitle = JSON.stringify(event.categories[0].title);

                    if (event.geometries[0].type == 'Point'){

                      var myPoint = {};
                      myPoint.lat = parseFloat(event.geometries[0].coordinates[1]);
                      myPoint.lng = parseFloat(event.geometries[0].coordinates[0]);
                      
                      //console.log(JSON.stringify(event.categories[0].title));

                      var marker = new google.maps.Marker({
                          position: myPoint,
                          map: map,
                          title: myTitle
                        });

                      // marker.addListener('click', function() {
                      //   marker.title = myTitle;
                      //   console.log(myTitle);
                      // });
                      // marker.title = myTitle;
                      // // To add the marker to the map, call setMap();
                      marker.setMap(map);
                    }

                    else if (event.geometries[0].type == 'Polygon'){

                      var allPolygons = event.geometries[0].coordinates[0];

                      var triangleCoords = [];  
  
                      $.each( allPolygons, function( index, value ){
                          var coord = {lat: value[1], lng: value[0]};
                          triangleCoords.push(coord);
                          
                      });
                       
                      // console.log(JSON.stringify(event.categories[0].title));

                      // Construct the polygon.
                      var bermudaTriangle = new google.maps.Polygon({
                        paths: triangleCoords,
                        strokeColor: '#FF0000',
                        strokeOpacity: 0.8,
                        strokeWeight: 2,
                        fillColor: '#FF0000',
                        fillOpacity: 0.35,
                        title: myTitle
                      });

                      attachPolygonInfoWindow(bermudaTriangle, '<strong>Info about this area</strong>');

                      bermudaTriangle.setMap(map);

                    }
                });
            });

 
      }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCmYvnjnsFJEJ2ZnL8adoadKRWOD_euQXc&callback=initMap"
    async defer></script>
  </body>
</html>