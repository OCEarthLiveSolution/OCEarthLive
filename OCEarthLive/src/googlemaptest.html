<!DOCTYPE html>
<html>
  <head>
    <title>OC Earth Live</title>

    <meta name="viewport" content="initial-scale=1.0">
    <script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>

    <meta charset="utf-8">
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <script>
      var map;

      var server = "http://eonet.sci.gsfc.nasa.gov/api/v2.1";

      var tweetServer = "http://0ed5f3fe.ngrok.io/tweets";
      
      function initMap() {

      var myLatLng = {lat: 33.629, lng: -117.949};
        
      var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 4,
          center: myLatLng
        });

        var infowindow = new google.maps.InfoWindow({
                size: new google.maps.Size(150, 50)
        });

        function getPinImage(pinColor){
            console.log(pinColor);
            var pinImage = new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|" + pinColor,
            new google.maps.Size(21, 34),
            new google.maps.Point(0,0),
            new google.maps.Point(10, 34));

            return pinImage;
        }

        function addInfoBox(myId, myTitle, myCategory, event){
            
            var contentString = "";
            
            if (myId != undefined){
              contentString += "Id: " + myId;
            }
            if (myTitle != undefined){
              contentString += "<br/>Event: " + myTitle;
            }
            if (myCategory != undefined){
              contentString += "<br/>Category: " + myCategory ;
            }
            if (event != undefined){
              contentString += "<br/>Location: " + event.latLng.toUrlValue(6);
            }

            infowindow.setContent(contentString);
            infowindow.setPosition(event.latLng);
            infowindow.open(map);
        }

        
        //Get the Tweets from our server
        $.getJSON( tweetServer, {
            status: "open",
            limit: 200
        })
        .done(function( data ) {
          $.each(data._items, function(key, event){

            var myId = JSON.stringify(event.eonet_id);
            var myTitle = JSON.stringify(event.name);

            var myPoint = {};
            myPoint.lat = parseFloat(JSON.parse(event.json_coordinates).coordinates[1]);
            myPoint.lng = parseFloat(JSON.parse(event.json_coordinates).coordinates[0]);
            
            var marker = new google.maps.Marker({
                position: myPoint,
                map: map,
                title: myTitle,
                icon: getPinImage("00FFFF")
              });

            google.maps.event.addListener(marker, 'click', function(event) {
              addInfoBox(myId, myTitle, undefined, event);
            });

            marker.setMap(map);
          });
       });

       //Get the events from the EONET Server
       $.getJSON( server + "/events", {
            status: "open",
            limit: 200
        })
            .done(function( data ) {
                $.each( data.events, function( key, event ) {

                    var myId = JSON.stringify(event.id);
                    var myTitle = JSON.stringify(event.title);
                    var myCategory = JSON.stringify(event.categories[0].title);
                    
                    if (event.geometries[0].type == 'Point'){

                      var myPoint = {};
                      myPoint.lat = parseFloat(event.geometries[0].coordinates[1]);
                      myPoint.lng = parseFloat(event.geometries[0].coordinates[0]);
                      
                      //console.log(JSON.stringify(event.categories[0].title));

                      var marker = new google.maps.Marker({
                          position: myPoint,
                          map: map,
                          title: myTitle,
                          icon: getPinImage("FF0000")
                        });

                      google.maps.event.addListener(marker, 'click', function(event) {
                        addInfoBox(myId, myTitle, myCategory, event);
                      });

                      marker.setMap(map);
                    }

                    else if (event.geometries[0].type == 'Polygon'){

                      var allPolygons = event.geometries[0].coordinates[0];

                      var triangleCoords = [];  
  
                      $.each( allPolygons, function( index, value ){
                          var coord = {lat: value[1], lng: value[0]};
                          triangleCoords.push(coord);
                          
                      });
                       
                      // console.log(JSON.stringify(event.categories[0].title));

                      // Construct the polygon.
                      var bermudaTriangle = new google.maps.Polygon({
                        paths: triangleCoords,
                        strokeColor: '#FF0000',
                        strokeOpacity: 0.8,
                        strokeWeight: 2,
                        fillColor: '#FF0000',
                        fillOpacity: 0.35,
                        title: myTitle
                      });

                      google.maps.event.addListener(bermudaTriangle, 'click', function(event) {
                        addInfoBox(myId, myTitle, myCategory, event);
                      });

                    
                    bermudaTriangle.setMap(map);

                    }
                });
            });
      }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCmYvnjnsFJEJ2ZnL8adoadKRWOD_euQXc&callback=initMap"
    async defer></script>
  </body>
</html>